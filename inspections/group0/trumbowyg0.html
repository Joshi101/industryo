<html><head><h4>#1 trumbowyg.js (...\templates\static\trumbowyg)</h4></head><body>/**<br> * Trumbowyg v2.2.0 - A lightweight WYSIWYG editor<br> * Trumbowyg core file<br> * ------------------------<br> * @link http://alex-d.github.io/Trumbowyg<br> * @license MIT<br> * @author Alexandre Demode (Alex-D)<br> *         Twitter : @AlexandreDemode<br> *         Website : alex-d.fr<br> */<br><br>jQuery.trumbowyg = {<br>    langs: {<br>        en: {<br>            viewHTML: &#39;View HTML&#39;,<br><br>            undo: &#39;Undo&#39;,<br>            redo: &#39;Redo&#39;,<br><br>            formatting: &#39;Formatting&#39;,<br>            p: &#39;Paragraph&#39;,<br>            blockquote: &#39;Quote&#39;,<br>            code: &#39;Code&#39;,<br>            header: &#39;Header&#39;,<br><br>            bold: &#39;Bold&#39;,<br>            italic: &#39;Italic&#39;,<br>            strikethrough: &#39;Stroke&#39;,<br>            underline: &#39;Underline&#39;,<br><br>            strong: &#39;Strong&#39;,<br>            em: &#39;Emphasis&#39;,<br>            del: &#39;Deleted&#39;,<br><br>            superscript: &#39;Superscript&#39;,<br>            subscript: &#39;Subscript&#39;,<br><br>            unorderedList: &#39;Unordered list&#39;,<br>            orderedList: &#39;Ordered list&#39;,<br><br>            insertImage: &#39;Insert Image&#39;,<br>            link: &#39;Link&#39;,<br>            createLink: &#39;Insert link&#39;,<br>            unlink: &#39;Remove link&#39;,<br><br>            justifyLeft: &#39;Align Left&#39;,<br>            justifyCenter: &#39;Align Center&#39;,<br>            justifyRight: &#39;Align Right&#39;,<br>            justifyFull: &#39;Align Justify&#39;,<br><br>            horizontalRule: &#39;Insert horizontal rule&#39;,<br>            removeformat: &#39;Remove format&#39;,<br><br>            fullscreen: &#39;Fullscreen&#39;,<br><br>            close: &#39;Close&#39;,<br><br>            submit: &#39;Confirm&#39;,<br>            reset: &#39;Cancel&#39;,<br><br>            required: &#39;Required&#39;,<br>            description: &#39;Description&#39;,<br>            title: &#39;Title&#39;,<br>            text: &#39;Text&#39;,<br>            target: &#39;Target&#39;<br>        }<br>    },<br><br>    // Plugins<br>    plugins: {},<br><br>    // SVG Path globally<br>    svgPath: null<br>};<br><br><br>(function (navigator, window, document, $) {<br>    &#39;use strict&#39;;<br><br>    $.fn.trumbowyg = function (options, params) {<br>        var trumbowygDataName = &#39;trumbowyg&#39;;<br>        if (options === Object(options) || !options) {<br>            return this.each(function () {<br>                if (!$(this).data(trumbowygDataName)) {<br>                    $(this).data(trumbowygDataName, new Trumbowyg(this, options));<br>                }<br>            });<br>        }<br>        if (this.length === 1) {<br>            try {<br>                var t = $(this).data(trumbowygDataName);<br>                switch (options) {<br>                    // Exec command<br>                    case &#39;execCmd&#39;:<br>                        return t.execCmd(params.cmd, params.param, params.forceCss);<br><br>                    // Modal box<br>                    case &#39;openModal&#39;:<br>                        return t.openModal(params.title, params.content);<br>                    case &#39;closeModal&#39;:<br>                        return t.closeModal();<br>                    case &#39;openModalInsert&#39;:<br>                        return t.openModalInsert(params.title, params.fields, params.callback);<br><br>                    // Range<br>                    case &#39;saveRange&#39;:<br>                        return t.saveRange();<br>                    case &#39;getRange&#39;:<br>                        return t.range;<br>                    case &#39;getRangeText&#39;:<br>                        return t.getRangeText();<br>                    case &#39;restoreRange&#39;:<br>                        return t.restoreRange();<br><br>                    // Enable/disable<br>                    case &#39;enable&#39;:<br>                        return t.toggleDisable(false);<br>                    case &#39;disable&#39;:<br>                        return t.toggleDisable(true);<br><br>                    // Destroy<br>                    case &#39;destroy&#39;:<br>                        return t.destroy();<br><br>                    // Empty<br>                    case &#39;empty&#39;:<br>                        return t.empty();<br><br>                    // HTML<br>                    case &#39;html&#39;:<br>                        return t.html(params);<br>                }<br>            } catch (c) {<br>            }<br>        }<br><br>        return false;<br>    };<br><br>    // @param: editorElem is the DOM element<br>    var Trumbowyg = function (editorElem, options) {<br>        var t = this,<br>            trumbowygIconsId = &#39;trumbowyg-icons&#39;;<br><br>        // Get the document of the element. It use to makes the plugin<br>        // compatible on iframes.<br>        t.doc = editorElem.ownerDocument || document;<br><br>        // jQuery object of the editor<br>        t.$ta = $(editorElem); // $ta : Textarea<br>        t.$c = $(editorElem); // $c : creator<br><br>        options = options || {};<br><br>        // Localization management<br>        if (options.lang != null || $.trumbowyg.langs[options.lang] != null) {<br>            t.lang = $.extend(true, {}, $.trumbowyg.langs.en, $.trumbowyg.langs[options.lang]);<br>        } else {<br>            t.lang = $.trumbowyg.langs.en;<br>        }<br><br>        // SVG path<br>        var svgPathOption = $.trumbowyg.svgPath != null ? $.trumbowyg.svgPath : options.svgPath;<br>        t.hasSvg = svgPathOption !== false;<br>        t.svgPath = !!t.doc.querySelector(&#39;base&#39;) ? window.location.href.split(&#39;#&#39;)[0] : &#39;&#39;;<br>        if ($(&#39;#&#39; + trumbowygIconsId, t.doc).length === 0 &amp;&amp; svgPathOption !== false) {<br>            if (svgPathOption == null) {<br>                try {<br>                    throw new Error();<br>                } catch (e) {<br>                    var stackLines = e.stack.split(&#39;\n&#39;);<br><br>                    for (var i in stackLines) {<br>                        if (!stackLines[i].match(/http[s]?:\/\//)) {<br>                            continue;<br>                        }<br>                        svgPathOption = stackLines[Number(i)].match(/((http[s]?:\/\/.+\/)([^\/]+\.js))(\?.*)?:/)[1].split(&#39;/&#39;);<br>                        svgPathOption.pop();<br>                        svgPathOption = svgPathOption.join(&#39;/&#39;) + &#39;/ui/icons.svg&#39;;<br>                        break;<br>                    }<br>                }<br>            }<br><br>            var div = t.doc.createElement(&#39;div&#39;);<br>            div.id = trumbowygIconsId;<br>            t.doc.body.insertBefore(div, t.doc.body.childNodes[0]);<br>            $.ajax({<br>                async: true,<br>                type: &#39;GET&#39;,<br>                contentType: &#39;application/x-www-form-urlencoded; charset=UTF-8&#39;,<br>                dataType: &#39;xml&#39;,<br>                url: svgPathOption,<br>                data: null,<br>                beforeSend: null,<br>                complete: null,<br>                success: function (data) {<br>                    div.innerHTML = new XMLSerializer().serializeToString(data.documentElement);<br>                }<br>            });<br>        }<br><br><br>        /**<br>         * When the button is associated to a empty object<br>         * fn and title attributs are defined from the button key value<br>         *<br>         * For example<br>         *      foo: {}<br>         * is equivalent to :<br>         *      foo: {<br>             *          fn: &#39;foo&#39;,<br>             *          title: this.lang.foo<br>             *      }<br>         */<br>        var h = t.lang.header, // Header translation<br>            isBlinkFunction = function () {<br>                return (window.chrome || (window.Intl &amp;&amp; Intl.v8BreakIterator)) &amp;&amp; &#39;CSS&#39; in window;<br>            };<br>        t.btnsDef = {<br>            viewHTML: {<br>                fn: &#39;toggle&#39;<br>            },<br><br>            undo: {<br>                isSupported: isBlinkFunction,<br>                key: &#39;Z&#39;<br>            },<br>            redo: {<br>                isSupported: isBlinkFunction,<br>                key: &#39;Y&#39;<br>            },<br><br>            p: {<br>                fn: &#39;formatBlock&#39;<br>            },<br>            blockquote: {<br>                fn: &#39;formatBlock&#39;<br>            },<br>            h1: {<br>                fn: &#39;formatBlock&#39;,<br>                title: h + &#39; 1&#39;<br>            },<br>            h2: {<br>                fn: &#39;formatBlock&#39;,<br>                title: h + &#39; 2&#39;<br>            },<br>            h3: {<br>                fn: &#39;formatBlock&#39;,<br>                title: h + &#39; 3&#39;<br>            },<br>            h4: {<br>                fn: &#39;formatBlock&#39;,<br>                title: h + &#39; 4&#39;<br>            },<br>            subscript: {<br>                tag: &#39;sub&#39;<br>            },<br>            superscript: {<br>                tag: &#39;sup&#39;<br>            },<br><br>            bold: {<br>                key: &#39;B&#39;<br>            },<br>            italic: {<br>                key: &#39;I&#39;<br>            },<br>            underline: {<br>                tag: &#39;u&#39;<br>            },<br>            strikethrough: {<br>                tag: &#39;strike&#39;<br>            },<br><br>            strong: {<br>                fn: &#39;bold&#39;,<br>                key: &#39;B&#39;<br>            },<br>            em: {<br>                fn: &#39;italic&#39;,<br>                key: &#39;I&#39;<br>            },<br>            del: {<br>                fn: &#39;strikethrough&#39;<br>            },<br><br>            createLink: {<br>                key: &#39;K&#39;,<br>                tag: &#39;a&#39;<br>            },<br>            unlink: {},<br><br>            insertImage: {},<br><br>            justifyLeft: {<br>                tag: &#39;left&#39;,<br>                forceCss: true<br>            },<br>            justifyCenter: {<br>                tag: &#39;center&#39;,<br>                forceCss: true<br>            },<br>            justifyRight: {<br>                tag: &#39;right&#39;,<br>                forceCss: true<br>            },<br>            justifyFull: {<br>                tag: &#39;justify&#39;,<br>                forceCss: true<br>            },<br><br>            unorderedList: {<br>                fn: &#39;insertUnorderedList&#39;,<br>                tag: &#39;ul&#39;<br>            },<br>            orderedList: {<br>                fn: &#39;insertOrderedList&#39;,<br>                tag: &#39;ol&#39;<br>            },<br><br>            horizontalRule: {<br>                fn: &#39;insertHorizontalRule&#39;<br>            },<br><br>            removeformat: {},<br><br>            fullscreen: {<br>                class: &#39;trumbowyg-not-disable&#39;<br>            },<br>            close: {<br>                fn: &#39;destroy&#39;,<br>                class: &#39;trumbowyg-not-disable&#39;<br>            },<br><br>            // Dropdowns<br>            formatting: {<br>                dropdown: [&#39;p&#39;, &#39;blockquote&#39;, &#39;h1&#39;, &#39;h2&#39;, &#39;h3&#39;, &#39;h4&#39;],<br>                ico: &#39;p&#39;<br>            },<br>            link: {<br>                dropdown: [&#39;createLink&#39;, &#39;unlink&#39;]<br>            }<br>        };<br><br>        // Defaults Options<br>        t.o = $.extend(true, {}, {<br>            lang: &#39;en&#39;,<br><br>            fixedBtnPane: false,<br>            fixedFullWidth: false,<br>            autogrow: false,<br><br>            prefix: &#39;trumbowyg-&#39;,<br><br>            semantic: true,<br>            resetCss: false,<br>            removeformatPasted: false,<br>            tagsToRemove: [],<br><br>            btnsGrps: {<br>                design: [&#39;bold&#39;, &#39;italic&#39;, &#39;underline&#39;, &#39;strikethrough&#39;],<br>                semantic: [&#39;strong&#39;, &#39;em&#39;, &#39;del&#39;],<br>                justify: [&#39;justifyLeft&#39;, &#39;justifyCenter&#39;, &#39;justifyRight&#39;, &#39;justifyFull&#39;],<br>                lists: [&#39;unorderedList&#39;, &#39;orderedList&#39;]<br>            },<br>            btns: [<br>                [&#39;viewHTML&#39;],<br>                [&#39;undo&#39;, &#39;redo&#39;],<br>                [&#39;formatting&#39;],<br>                &#39;btnGrp-semantic&#39;,<br>                [&#39;superscript&#39;, &#39;subscript&#39;],<br>                [&#39;link&#39;],<br>                [&#39;insertImage&#39;],<br>                &#39;btnGrp-justify&#39;,<br>                &#39;btnGrp-lists&#39;,<br>                [&#39;horizontalRule&#39;],<br>                [&#39;removeformat&#39;],<br>                [&#39;fullscreen&#39;]<br>            ],<br>            // For custom button definitions<br>            btnsDef: {},<br><br>            inlineElementsSelector: &#39;a,abbr,acronym,b,caption,cite,code,col,dfn,dir,dt,dd,em,font,hr,i,kbd,li,q,span,strikeout,strong,sub,sup,u&#39;,<br><br>            pasteHandlers: [],<br><br>            imgDblClickHandler: function () {<br>                var $img = $(this),<br>                    src = $img.attr(&#39;src&#39;),<br>                    base64 = &#39;(Base64)&#39;;<br><br>                if (src.indexOf(&#39;data:image&#39;) === 0) {<br>                    src = base64;<br>                }<br><br>                t.openModalInsert(t.lang.insertImage, {<br>                    url: {<br>                        label: &#39;URL&#39;,<br>                        value: src,<br>                        required: true<br>                    },<br>                    alt: {<br>                        label: t.lang.description,<br>                        value: $img.attr(&#39;alt&#39;)<br>                    }<br>                }, function (v) {<br>                    if (v.src !== base64) {<br>                        $img.attr({<br>                            src: v.src<br>                        });<br>                    }<br>                    $img.attr({<br>                        alt: v.alt<br>                    });<br>                    return true;<br>                });<br>                return false;<br>            },<br><br>            plugins: {}<br>        }, options);<br><br>        t.disabled = t.o.disabled || (editorElem.nodeName === &#39;TEXTAREA&#39; &amp;&amp; editorElem.disabled);<br><br>        if (options.btns) {<br>            t.o.btns = options.btns;<br>        } else if (!t.o.semantic) {<br>            t.o.btns[4] = &#39;btnGrp-design&#39;;<br>        }<br><br>        $.each(t.o.btnsDef, function (btnName, btnDef) {<br>            t.addBtnDef(btnName, btnDef);<br>        });<br><br>        // Keyboard shortcuts are load in this array<br>        t.keys = [];<br><br>        // Tag to button dynamically hydrated<br>        t.tagToButton = {};<br>        t.tagHandlers = [];<br><br>        // Admit multiple paste handlers<br>        t.pasteHandlers = [].concat(t.o.pasteHandlers);<br><br>        t.init();<br>    };<br><br>    Trumbowyg.prototype = {<br>        init: function () {<br>            var t = this;<br>            t.height = t.$ta.height();<br><br>            t.initPlugins();<br><br>            try {<br>                // Disable image resize, try-catch for old IE<br>                t.doc.execCommand(&#39;enableObjectResizing&#39;, false, false);<br>            } catch (e) {<br>            }<br>            t.doc.execCommand(&#39;defaultParagraphSeparator&#39;, false, &#39;p&#39;);<br><br>            t.buildEditor();<br>            t.buildBtnPane();<br><br>            t.fixedBtnPaneEvents();<br><br>            t.buildOverlay();<br><br>            setTimeout(function () {<br>                if (t.disabled) {<br>                    t.toggleDisable(true);<br>                }<br>                t.$c.trigger(&#39;tbwinit&#39;);<br>            });<br>        },<br><br>        addBtnDef: function (btnName, btnDef) {<br>            this.btnsDef[btnName] = btnDef;<br>        },<br><br>        buildEditor: function () {<br>            var t = this,<br>                prefix = t.o.prefix,<br>                html = &#39;&#39;;<br><br>            t.$box = $(&#39;&lt;div/&gt;&#39;, {<br>                class: prefix + &#39;box &#39; + prefix + &#39;editor-visible &#39; + prefix + t.o.lang + &#39; trumbowyg&#39;<br>            });<br><br>            // $ta = Textarea<br>            // $ed = Editor<br>            t.isTextarea = t.$ta.is(&#39;textarea&#39;);<br>            if (t.isTextarea) {<br>                html = t.$ta.val();<br>                t.$ed = $(&#39;&lt;div/&gt;&#39;);<br>                t.$box<br>                    .insertAfter(t.$ta)<br>                    .append(t.$ed, t.$ta);<br>            } else {<br>                t.$ed = t.$ta;<br>                html = t.$ed.html();<br><br>                t.$ta = $(&#39;&lt;textarea/&gt;&#39;, {<br>                    name: t.$ta.attr(&#39;id&#39;),<br>                    height: t.height<br>                }).val(html);<br><br>                t.$box<br>                    .insertAfter(t.$ed)<br>                    .append(t.$ta, t.$ed);<br>                t.syncCode();<br>            }<br><br>            t.$ta<br>                .addClass(prefix + &#39;textarea&#39;)<br>                .attr(&#39;tabindex&#39;, -1)<br>            ;<br><br>            t.$ed<br>                .addClass(prefix + &#39;editor&#39;)<br>                .attr({<br>                    contenteditable: true,<br>                    dir: t.lang._dir || &#39;ltr&#39;<br>                })<br>                .html(html)<br>            ;<br><br>            if (t.o.tabindex) {<br>                t.$ed.attr(&#39;tabindex&#39;, t.o.tabindex);<br>            }<br><br>            if (t.$c.is(&#39;[placeholder]&#39;)) {<br>                t.$ed.attr(&#39;placeholder&#39;, t.$c.attr(&#39;placeholder&#39;));<br>            }<br><br>            if (t.o.resetCss) {<br>                t.$ed.addClass(prefix + &#39;reset-css&#39;);<br>            }<br><br>            if (!t.o.autogrow) {<br>                t.$ta.add(t.$ed).css({<br>                    height: t.height<br>                });<br>            }<br><br>            t.semanticCode();<br><br><br>            var ctrl = false,<br>                composition = false,<br>                debounceButtonPaneStatus;<br><br>            t.$ed<br>                .on(&#39;dblclick&#39;, &#39;img&#39;, t.o.imgDblClickHandler)<br>                .on(&#39;keydown&#39;, function (e) {<br>                    composition = (e.which === 229);<br><br>                    if (e.ctrlKey) {<br>                        ctrl = true;<br>                        var k = t.keys[String.fromCharCode(e.which).toUpperCase()];<br><br>                        try {<br>                            t.execCmd(k.fn, k.param);<br>                            return false;<br>                        } catch (c) {<br>                        }<br>                    }<br>                })<br>                .on(&#39;keyup input&#39;, function (e) {<br>                    if (e.which &gt;= 37 &amp;&amp; e.which &lt;= 40) {<br>                        return;<br>                    }<br><br>                    if (e.ctrlKey &amp;&amp; (e.which === 89 || e.which === 90)) {<br>                        t.$c.trigger(&#39;tbwchange&#39;);<br>                    } else if (!ctrl &amp;&amp; e.which !== 17 &amp;&amp; !composition) {<br>                        t.semanticCode(false, e.which === 13);<br>                        t.$c.trigger(&#39;tbwchange&#39;);<br>                    }<br><br>                    setTimeout(function () {<br>                        ctrl = false;<br>                    }, 200);<br>                })<br>                .on(&#39;mouseup keydown keyup&#39;, function () {<br>                    clearTimeout(debounceButtonPaneStatus);<br>                    debounceButtonPaneStatus = setTimeout(function () {<br>                        t.updateButtonPaneStatus();<br>                    }, 50);<br>                })<br>                .on(&#39;focus blur&#39;, function (e) {<br>                    t.$c.trigger(&#39;tbw&#39; + e.type);<br>                    if (e.type === &#39;blur&#39;) {<br>                        $(&#39;.&#39; + prefix + &#39;active-button&#39;, t.$btnPane).removeClass(prefix + &#39;active-button &#39; + prefix + &#39;active&#39;);<br>                    }<br>                })<br>                .on(&#39;cut&#39;, function () {<br>                    setTimeout(function () {<br>                        t.semanticCode(false, true);<br>                        t.$c.trigger(&#39;tbwchange&#39;);<br>                    }, 0);<br>                })<br>                .on(&#39;paste&#39;, function (e) {<br>                    if (t.o.removeformatPasted) {<br>                        e.preventDefault();<br><br>                        try {<br>                            // IE<br>                            var text = window.clipboardData.getData(&#39;Text&#39;);<br><br>                            try {<br>                                // &lt;= IE10<br>                                t.doc.selection.createRange().pasteHTML(text);<br>                            } catch (c) {<br>                                // IE 11<br>                                t.doc.getSelection().getRangeAt(0).insertNode(t.doc.createTextNode(text));<br>                            }<br>                        } catch (d) {<br>                            // Not IE<br>                            t.execCmd(&#39;insertText&#39;, (e.originalEvent || e).clipboardData.getData(&#39;text/plain&#39;));<br>                        }<br>                    }<br><br>                    // Call pasteHandlers<br>                    $.each(t.pasteHandlers, function (i, pasteHandler) {<br>                        pasteHandler(e);<br>                    });<br><br>                    setTimeout(function () {<br>                        t.semanticCode(false, true);<br>                        t.$c.trigger(&#39;tbwpaste&#39;, e);<br>                    }, 0);<br>                });<br>            t.$ta.on(&#39;keyup paste&#39;, function () {<br>                t.$c.trigger(&#39;tbwchange&#39;);<br>            });<br><br>            t.$box.on(&#39;keydown&#39;, function (e) {<br>                if (e.which === 27 &amp;&amp; $(&#39;.&#39; + prefix + &#39;modal-box&#39;, t.$box).length === 1) {<br>                    t.closeModal();<br>                    return false;<br>                }<br>            });<br>        },<br><br><br>        // Build button pane, use o.btns option<br>        buildBtnPane: function () {<br>            var t = this,<br>                prefix = t.o.prefix;<br><br>            var $btnPane = t.$btnPane = $(&#39;&lt;div/&gt;&#39;, {<br>                class: prefix + &#39;button-pane&#39;<br>            });<br><br>            $.each(t.o.btns, function (i, btnGrps) {<br>                // Managment of group of buttons<br>                try {<br>                    var b = btnGrps.split(&#39;btnGrp-&#39;);<br>                    if (b[1] != null) {<br>                        btnGrps = t.o.btnsGrps[b[1]];<br>                    }<br>                } catch (c) {<br>                }<br><br>                if (!$.isArray(btnGrps)) {<br>                    btnGrps = [btnGrps];<br>                }<br><br>                var $btnGroup = $(&#39;&lt;div/&gt;&#39;, {<br>                    class: prefix + &#39;button-group &#39; + ((btnGrps.indexOf(&#39;fullscreen&#39;) &gt;= 0) ? prefix + &#39;right&#39; : &#39;&#39;)<br>                });<br>                $.each(btnGrps, function (i, btn) {<br>                    try { // Prevent buildBtn error<br>                        var $item;<br><br>                        if (t.isSupportedBtn(btn)) { // It&#39;s a supported button<br>                            $item = t.buildBtn(btn);<br>                        }<br><br>                        $btnGroup.append($item);<br>                    } catch (c) {<br>                    }<br>                });<br>                $btnPane.append($btnGroup);<br>            });<br><br>            t.$box.prepend($btnPane);<br>        },<br><br><br>        // Build a button and his action<br>        buildBtn: function (btnName) { // btnName is name of the button<br>            var t = this,<br>                prefix = t.o.prefix,<br>                btn = t.btnsDef[btnName],<br>                isDropdown = btn.dropdown,<br>                textDef = t.lang[btnName] || btnName,<br><br>                $btn = $(&#39;&lt;button/&gt;&#39;, {<br>                    type: &#39;button&#39;,<br>                    class: prefix + btnName + &#39;-button &#39; + (btn.class || &#39;&#39;),<br>                    html: t.hasSvg ? &#39;&lt;svg&gt;&lt;use xlink:href=&quot;&#39; + t.svgPath + &#39;#&#39; + prefix + (btn.ico || btnName).replace(/([A-Z]+)/g, &#39;-$1&#39;).toLowerCase() + &#39;&quot;/&gt;&lt;/svg&gt;&#39; : &#39;&#39;,<br>                    title: (btn.title || btn.text || textDef) + ((btn.key) ? &#39; (Ctrl + &#39; + btn.key + &#39;)&#39; : &#39;&#39;),<br>                    tabindex: -1,<br>                    mousedown: function () {<br>                        if (!isDropdown || $(&#39;.&#39; + btnName + &#39;-&#39; + prefix + &#39;dropdown&#39;, t.$box).is(&#39;:hidden&#39;)) {<br>                            $(&#39;body&#39;, t.doc).trigger(&#39;mousedown&#39;);<br>                        }<br><br>                        if (t.$btnPane.hasClass(prefix + &#39;disable&#39;) &amp;&amp; !$(this).hasClass(prefix + &#39;active&#39;) &amp;&amp; !$(this).hasClass(prefix + &#39;not-disable&#39;)) {<br>                            return false;<br>                        }<br><br>                        t.execCmd((isDropdown ? &#39;dropdown&#39; : false) || btn.fn || btnName, btn.param || btnName, btn.forceCss || false);<br><br>                        return false;<br>                    }<br>                });<br><br>            if (isDropdown) {<br>                $btn.addClass(prefix + &#39;open-dropdown&#39;);<br>                var dropdownPrefix = prefix + &#39;dropdown&#39;,<br>                    $dropdown = $(&#39;&lt;div/&gt;&#39;, { // the dropdown<br>                        class: dropdownPrefix + &#39;-&#39; + btnName + &#39; &#39; + dropdownPrefix + &#39; &#39; + prefix + &#39;fixed-top&#39;,<br>                        &#39;data-dropdown&#39;: btnName<br>                    });<br>                $.each(isDropdown, function (i, def) {<br>                    if (t.btnsDef[def] &amp;&amp; t.isSupportedBtn(def)) {<br>                        $dropdown.append(t.buildSubBtn(def));<br>                    }<br>                });<br>                t.$box.append($dropdown.hide());<br>            } else if (btn.key) {<br>                t.keys[btn.key] = {<br>                    fn: btn.fn || btnName,<br>                    param: btn.param || btnName<br>                };<br>            }<br><br>            if (!isDropdown) {<br>                t.tagToButton[(btn.tag || btnName).toLowerCase()] = btnName;<br>            }<br><br>            return $btn;<br>        },<br>        // Build a button for dropdown menu<br>        // @param n : name of the subbutton<br>        buildSubBtn: function (btnName) {<br>            var t = this,<br>                prefix = t.o.prefix,<br>                btn = t.btnsDef[btnName];<br><br>            if (btn.key) {<br>                t.keys[btn.key] = {<br>                    fn: btn.fn || btnName,<br>                    param: btn.param || btnName<br>                };<br>            }<br><br>            t.tagToButton[(btn.tag || btnName).toLowerCase()] = btnName;<br><br>            return $(&#39;&lt;button/&gt;&#39;, {<br>                type: &#39;button&#39;,<br>                class: prefix + btnName + &#39;-dropdown-button&#39; + (btn.ico ? &#39; &#39; + prefix + btn.ico + &#39;-button&#39; : &#39;&#39;),<br>                html: t.hasSvg ? &#39;&lt;svg&gt;&lt;use xlink:href=&quot;&#39; + t.svgPath + &#39;#&#39; + prefix + (btn.ico || btnName).replace(/([A-Z]+)/g, &#39;-$1&#39;).toLowerCase() + &#39;&quot;/&gt;&lt;/svg&gt;&#39; + (btn.text || btn.title || t.lang[btnName] || btnName) : &#39;&#39;,<br>                title: ((btn.key) ? &#39; (Ctrl + &#39; + btn.key + &#39;)&#39; : null),<br>                style: btn.style || null,<br>                mousedown: function () {<br>                    $(&#39;body&#39;, t.doc).trigger(&#39;mousedown&#39;);<br><br>                    t.execCmd(btn.fn || btnName, btn.param || btnName, btn.forceCss || false);<br><br>                    return false;<br>                }<br>            });<br>        },<br>        // Check if button is supported<br>        isSupportedBtn: function (b) {<br>            try {<br>                return this.btnsDef[b].isSupported();<br>            } catch (c) {<br>            }<br>            return true;<br>        },<br><br>        // Build overlay for modal box<br>        buildOverlay: function () {<br>            var t = this;<br>            t.$overlay = $(&#39;&lt;div/&gt;&#39;, {<br>                class: t.o.prefix + &#39;overlay&#39;<br>            }).css({<br>                top: t.$btnPane.outerHeight(),<br>                height: (t.$ed.outerHeight() + 1) + &#39;px&#39;<br>            }).appendTo(t.$box);<br>            return t.$overlay;<br>        },<br>        showOverlay: function () {<br>            var t = this;<br>            $(window).trigger(&#39;scroll&#39;);<br>            t.$overlay.fadeIn(200);<br>            t.$box.addClass(t.o.prefix + &#39;box-blur&#39;);<br>        },<br>        hideOverlay: function () {<br>            var t = this;<br>            t.$overlay.fadeOut(50);<br>            t.$box.removeClass(t.o.prefix + &#39;box-blur&#39;);<br>        },<br><br>        // Management of fixed button pane<br>        fixedBtnPaneEvents: function () {<br>            var t = this,<br>                fixedFullWidth = t.o.fixedFullWidth,<br>                $box = t.$box;<br><br>            if (!t.o.fixedBtnPane) {<br>                return;<br>            }<br><br>            t.isFixed = false;<br><br>            $(window)<br>                .on(&#39;scroll resize&#39;, function () {<br>                    if (!$box) {<br>                        return;<br>                    }<br><br>                    t.syncCode();<br><br>                    var scrollTop = $(window).scrollTop(),<br>                        offset = $box.offset().top + 1,<br>                        bp = t.$btnPane,<br>                        oh = bp.outerHeight() - 2;<br><br>                    if ((scrollTop - offset &gt; 0) &amp;&amp; ((scrollTop - offset - t.height) &lt; 0)) {<br>                        if (!t.isFixed) {<br>                            t.isFixed = true;<br>                            bp.css({<br>                                position: &#39;fixed&#39;,<br>                                top: 0,<br>                                left: fixedFullWidth ? &#39;0&#39; : &#39;auto&#39;,<br>                                zIndex: 7<br>                            });<br>                            $([t.$ta, t.$ed]).css({marginTop: bp.height()});<br>                        }<br>                        bp.css({<br>                            width: fixedFullWidth ? &#39;100%&#39; : (($box.width() - 1) + &#39;px&#39;)<br>                        });<br><br>                        $(&#39;.&#39; + t.o.prefix + &#39;fixed-top&#39;, $box).css({<br>                            position: fixedFullWidth ? &#39;fixed&#39; : &#39;absolute&#39;,<br>                            top: fixedFullWidth ? oh : oh + (scrollTop - offset) + &#39;px&#39;,<br>                            zIndex: 15<br>                        });<br>                    } else if (t.isFixed) {<br>                        t.isFixed = false;<br>                        bp.removeAttr(&#39;style&#39;);<br>                        $([t.$ta, t.$ed]).css({marginTop: 0});<br>                        $(&#39;.&#39; + t.o.prefix + &#39;fixed-top&#39;, $box).css({<br>                            position: &#39;absolute&#39;,<br>                            top: oh<br>                        });<br>                    }<br>                });<br>        },<br><br>        // Disable editor<br>        toggleDisable: function (disable) {<br>            var t = this,<br>                prefix = t.o.prefix;<br><br>            t.disabled = disable;<br><br>            if (disable) {<br>                t.$ta.attr(&#39;disabled&#39;, true);<br>            } else {<br>                t.$ta.removeAttr(&#39;disabled&#39;);<br>            }<br>            t.$box.toggleClass(prefix + &#39;disabled&#39;, disable);<br>            t.$ed.attr(&#39;contenteditable&#39;, !disable);<br>        },<br><br>        // Destroy the editor<br>        destroy: function () {<br>            var t = this,<br>                prefix = t.o.prefix,<br>                height = t.height;<br><br>            if (t.isTextarea) {<br>                t.$box.after(<br>                    t.$ta<br>                        .css({height: height})<br>                        .val(t.html())<br>                        .removeClass(prefix + &#39;textarea&#39;)<br>                        .show()<br>                );<br>            } else {<br>                t.$box.after(<br>                    t.$ed<br>                        .css({height: height})<br>                        .removeClass(prefix + &#39;editor&#39;)<br>                        .removeAttr(&#39;contenteditable&#39;)<br>                        .html(t.html())<br>                        .show()<br>                );<br>            }<br><br>            t.$ed.off(&#39;dblclick&#39;, &#39;img&#39;);<br><br>            t.destroyPlugins();<br><br>            t.$box.remove();<br>            t.$c.removeData(&#39;trumbowyg&#39;);<br>            $(&#39;body&#39;).removeClass(prefix + &#39;body-fullscreen&#39;);<br>            t.$c.trigger(&#39;tbwclose&#39;);<br>        },<br><br><br>        // Empty the editor<br>        empty: function () {<br>            this.$ta.val(&#39;&#39;);<br>            this.syncCode(true);<br>        },<br><br><br>        // Function call when click on viewHTML button<br>        toggle: function () {<br>            var t = this,<br>                prefix = t.o.prefix;<br>            t.semanticCode(false, true);<br>            setTimeout(function () {<br>                t.doc.activeElement.blur();<br>                t.$box.toggleClass(prefix + &#39;editor-hidden &#39; + prefix + &#39;editor-visible&#39;);<br>                t.$btnPane.toggleClass(prefix + &#39;disable&#39;);<br>                $(&#39;.&#39; + prefix + &#39;viewHTML-button&#39;, t.$btnPane).toggleClass(prefix + &#39;active&#39;);<br>                if (t.$box.hasClass(prefix + &#39;editor-visible&#39;)) {<br>                    t.$ta.attr(&#39;tabindex&#39;, -1);<br>                } else {<br>                    t.$ta.removeAttr(&#39;tabindex&#39;);<br>                }<br>            }, 0);<br>        },<br><br>        // Open dropdown when click on a button which open that<br>        dropdown: function (name) {<br>            var t = this,<br>                d = t.doc,<br>                prefix = t.o.prefix,<br>                $dropdown = $(&#39;[data-dropdown=&#39; + name + &#39;]&#39;, t.$box),<br>                $btn = $(&#39;.&#39; + prefix + name + &#39;-button&#39;, t.$btnPane),<br>                show = $dropdown.is(&#39;:hidden&#39;);<br><br>            $(&#39;body&#39;, d).trigger(&#39;mousedown&#39;);<br><br>            if (show) {<br>                var o = $btn.offset().left;<br>                $btn.addClass(prefix + &#39;active&#39;);<br><br>                $dropdown.css({<br>                    position: &#39;absolute&#39;,<br>                    top: $btn.offset().top - t.$btnPane.offset().top + $btn.outerHeight(),<br>                    left: (t.o.fixedFullWidth &amp;&amp; t.isFixed) ? o + &#39;px&#39; : (o - t.$btnPane.offset().left) + &#39;px&#39;<br>                }).show();<br><br>                $(window).trigger(&#39;scroll&#39;);<br><br>                $(&#39;body&#39;, d).on(&#39;mousedown&#39;, function () {<br>                    $(&#39;.&#39; + prefix + &#39;dropdown&#39;, d).hide();<br>                    $(&#39;.&#39; + prefix + &#39;active&#39;, d).removeClass(prefix + &#39;active&#39;);<br>                    $(&#39;body&#39;, d).off(&#39;mousedown&#39;);<br>                });<br>            }<br>        },<br><br><br>        // HTML Code management<br>        html: function (html) {<br>            var t = this;<br>            if (html != null) {<br>                t.$ta.val(html);<br>                t.syncCode(true);<br>                return t;<br>            }<br>            return t.$ta.val();<br>        },<br>        syncTextarea: function () {<br>            var t = this;<br>            t.$ta.val(t.$ed.text().trim().length &gt; 0 || t.$ed.find(&#39;hr,img,embed,iframe,input&#39;).length &gt; 0 ? t.$ed.html() : &#39;&#39;);<br>        },<br>        syncCode: function (force) {<br>            var t = this;<br>            if (!force &amp;&amp; t.$ed.is(&#39;:visible&#39;)) {<br>                t.syncTextarea();<br>            } else {<br>                t.$ed.html(t.$ta.val());<br>            }<br><br>            if (t.o.autogrow) {<br>                t.height = t.$ed.height();<br>                if (t.height !== t.$ta.css(&#39;height&#39;)) {<br>                    t.$ta.css({height: t.height});<br>                    t.$c.trigger(&#39;tbwresize&#39;);<br>                }<br>            }<br>        },<br><br>        // Analyse and update to semantic code<br>        // @param force : force to sync code from textarea<br>        // @param full  : wrap text nodes in &lt;p&gt;<br>        semanticCode: function (force, full) {<br>            var t = this;<br>            t.saveRange();<br>            t.syncCode(force);<br><br>            $(t.o.tagsToRemove.join(&#39;,&#39;), t.$ed).remove();<br><br>            if (t.o.semantic) {<br>                t.semanticTag(&#39;b&#39;, &#39;strong&#39;);<br>                t.semanticTag(&#39;i&#39;, &#39;em&#39;);<br><br>                if (full) {<br>                    var inlineElementsSelector = t.o.inlineElementsSelector,<br>                        blockElementsSelector = &#39;:not(&#39; + inlineElementsSelector + &#39;)&#39;;<br><br>                    // Wrap text nodes in span for easier processing<br>                    t.$ed.contents().filter(function () {<br>                        return this.nodeType === 3 &amp;&amp; this.nodeValue.trim().length &gt; 0;<br>                    }).wrap(&#39;&lt;span data-tbw/&gt;&#39;);<br><br>                    // Wrap groups of inline elements in paragraphs (recursive)<br>                    var wrapInlinesInParagraphsFrom = function ($from) {<br>                        if ($from.length !== 0) {<br>                            var $finalParagraph = $from.nextUntil(blockElementsSelector).addBack().wrapAll(&#39;&lt;p/&gt;&#39;).parent(),<br>                                $nextElement = $finalParagraph.nextAll(inlineElementsSelector).first();<br>                            $finalParagraph.next(&#39;br&#39;).remove();<br>                            wrapInlinesInParagraphsFrom($nextElement);<br>                        }<br>                    };<br>                    wrapInlinesInParagraphsFrom(t.$ed.children(inlineElementsSelector).first());<br><br>                    t.semanticTag(&#39;div&#39;, &#39;p&#39;, true);<br><br>                    // Unwrap paragraphs content, containing nothing usefull<br>                    t.$ed.find(&#39;p&#39;).filter(function () {<br>                        // Don&#39;t remove currently being edited element<br>                        if (t.range &amp;&amp; this === t.range.startContainer) {<br>                            return false;<br>                        }<br>                        return $(this).text().trim().length === 0 &amp;&amp; $(this).children().not(&#39;br,span&#39;).length === 0;<br>                    }).contents().unwrap();<br><br>                    // Get rid of temporial span&#39;s<br>                    $(&#39;[data-tbw]&#39;, t.$ed).contents().unwrap();<br><br>                    // Remove empty &lt;p&gt;<br>                    t.$ed.find(&#39;p:empty&#39;).remove();<br>                }<br><br>                t.restoreRange();<br><br>                t.syncTextarea();<br>            }<br>        },<br><br>        semanticTag: function (oldTag, newTag, copyAttributes) {<br>            $(oldTag, this.$ed).each(function () {<br>                var $oldTag = $(this);<br>                $oldTag.wrap(&#39;&lt;&#39; + newTag + &#39;/&gt;&#39;);<br>                if (copyAttributes) {<br>                    $.each($oldTag.prop(&#39;attributes&#39;), function () {<br>                        $oldTag.parent().attr(this.name, this.value);<br>                    });<br>                }<br>                $oldTag.contents().unwrap();<br>            });<br>        },<br><br>        // Function call when user click on &quot;Insert Link&quot;<br>        createLink: function () {<br>            var t = this,<br>                documentSelection = t.doc.getSelection(),<br>                node = documentSelection.focusNode,<br>                url,<br>                title,<br>                target;<br><br>            while ([&#39;A&#39;, &#39;DIV&#39;].indexOf(node.nodeName) &lt; 0) {<br>                node = node.parentNode;<br>            }<br><br>            if (node &amp;&amp; node.nodeName === &#39;A&#39;) {<br>                var $a = $(node);<br>                url = $a.attr(&#39;href&#39;);<br>                title = $a.attr(&#39;title&#39;);<br>                target = $a.attr(&#39;target&#39;);<br>                var range = t.doc.createRange();<br>                range.selectNode(node);<br>                documentSelection.addRange(range);<br>            }<br><br>            t.saveRange();<br><br>            t.openModalInsert(t.lang.createLink, {<br>                url: {<br>                    label: &#39;URL&#39;,<br>                    required: true,<br>                    value: url<br>                },<br>                title: {<br>                    label: t.lang.title,<br>                    value: title<br>                },<br>                text: {<br>                    label: t.lang.text,<br>                    value: t.getRangeText()<br>                },<br>                target: {<br>                    label: t.lang.target,<br>                    value: target<br>                }<br>            }, function (v) { // v is value<br>                var link = $([&#39;&lt;a href=&quot;&#39;, v.url, &#39;&quot;&gt;&#39;, v.text, &#39;&lt;/a&gt;&#39;].join(&#39;&#39;));<br>                if (v.title.length &gt; 0) {<br>                    link.attr(&#39;title&#39;, v.title);<br>                }<br>                if (v.target.length &gt; 0) {<br>                    link.attr(&#39;target&#39;, v.target);<br>                }<br>                t.range.deleteContents();<br>                t.range.insertNode(link[0]);<br>                return true;<br>            });<br>        },<br>        unlink: function () {<br>            var t = this,<br>                documentSelection = t.doc.getSelection(),<br>                node = documentSelection.focusNode;<br><br>            if (documentSelection.isCollapsed) {<br>                while ([&#39;A&#39;, &#39;DIV&#39;].indexOf(node.nodeName) &lt; 0) {<br>                    node = node.parentNode;<br>                }<br><br>                if (node &amp;&amp; node.nodeName === &#39;A&#39;) {<br>                    var range = t.doc.createRange();<br>                    range.selectNode(node);<br>                    documentSelection.addRange(range);<br>                }<br>            }<br>            t.execCmd(&#39;unlink&#39;, undefined, undefined, true);<br>        },<br>        insertImage: function () {<br>            var t = this;<br>            t.saveRange();<br>            t.openModalInsert(t.lang.insertImage, {<br>                url: {<br>                    label: &#39;URL&#39;,<br>                    required: true<br>                },<br>                alt: {<br>                    label: t.lang.description,<br>                    value: t.getRangeText()<br>                }<br>            }, function (v) { // v are values<br>                t.execCmd(&#39;insertImage&#39;, v.url);<br>                $(&#39;img[src=&quot;&#39; + v.url + &#39;&quot;]:not([alt])&#39;, t.$box).attr(&#39;alt&#39;, v.alt);<br>                return true;<br>            });<br>        },<br>        fullscreen: function () {<br>            var t = this,<br>                prefix = t.o.prefix,<br>                fullscreenCssClass = prefix + &#39;fullscreen&#39;,<br>                isFullscreen;<br><br>            t.$box.toggleClass(fullscreenCssClass);<br>            isFullscreen = t.$box.hasClass(fullscreenCssClass);<br>            $(&#39;body&#39;).toggleClass(prefix + &#39;body-fullscreen&#39;, isFullscreen);<br>            $(window).trigger(&#39;scroll&#39;);<br>            t.$c.trigger(&#39;tbw&#39; + (isFullscreen ? &#39;open&#39; : &#39;close&#39;) + &#39;fullscreen&#39;);<br>        },<br><br><br>        /*<br>         * Call method of trumbowyg if exist<br>         * else try to call anonymous function<br>         * and finaly native execCommand<br>         */<br>        execCmd: function (cmd, param, forceCss, skipTrumbowyg) {<br>            var t = this;<br>            skipTrumbowyg = !!skipTrumbowyg || &#39;&#39;;<br><br>            if (cmd !== &#39;dropdown&#39;) {<br>                t.$ed.focus();<br>            }<br><br>            try {<br>                t.doc.execCommand(&#39;styleWithCSS&#39;, false, forceCss || false);<br>            } catch (c) {<br>            }<br><br>            try {<br>                t[cmd + skipTrumbowyg](param);<br>            } catch (c) {<br>                try {<br>                    cmd(param);<br>                } catch (e2) {<br>                    if (cmd === &#39;insertHorizontalRule&#39;) {<br>                        param = undefined;<br>                    } else if (cmd === &#39;formatBlock&#39; &amp;&amp; (navigator.userAgent.indexOf(&#39;MSIE&#39;) !== -1 || navigator.appVersion.indexOf(&#39;Trident/&#39;) !== -1)) {<br>                        param = &#39;&lt;&#39; + param + &#39;&gt;&#39;;<br>                    }<br><br>                    t.doc.execCommand(cmd, false, param);<br><br>                    t.syncCode();<br>                    t.semanticCode(false, true);<br>                }<br><br>                if (cmd !== &#39;dropdown&#39;) {<br>                    t.updateButtonPaneStatus();<br>                    t.$c.trigger(&#39;tbwchange&#39;);<br>                }<br>            }<br>        },<br><br><br>        // Open a modal box<br>        openModal: function (title, content) {<br>            var t = this,<br>                prefix = t.o.prefix;<br><br>            // No open a modal box when exist other modal box<br>            if ($(&#39;.&#39; + prefix + &#39;modal-box&#39;, t.$box).length &gt; 0) {<br>                return false;<br>            }<br><br>            t.saveRange();<br>            t.showOverlay();<br><br>            // Disable all btnPane btns<br>            t.$btnPane.addClass(prefix + &#39;disable&#39;);<br><br>            // Build out of ModalBox, it&#39;s the mask for animations<br>            var $modal = $(&#39;&lt;div/&gt;&#39;, {<br>                class: prefix + &#39;modal &#39; + prefix + &#39;fixed-top&#39;<br>            }).css({<br>                top: t.$btnPane.height()<br>            }).appendTo(t.$box);<br><br>            // Click on overlay close modal by cancelling them<br>            t.$overlay.one(&#39;click&#39;, function () {<br>                $modal.trigger(&#39;tbwcancel&#39;);<br>                return false;<br>            });<br><br>            // Build the form<br>            var $form = $(&#39;&lt;form/&gt;&#39;, {<br>                action: &#39;&#39;,<br>                html: content<br>            })<br>                .on(&#39;submit&#39;, function () {<br>                    $modal.trigger(&#39;tbwconfirm&#39;);<br>                    return false;<br>                })<br>                .on(&#39;reset&#39;, function () {<br>                    $modal.trigger(&#39;tbwcancel&#39;);<br>                    return false;<br>                });<br><br><br>            // Build ModalBox and animate to show them<br>            var $box = $(&#39;&lt;div/&gt;&#39;, {<br>                class: prefix + &#39;modal-box&#39;,<br>                html: $form<br>            })<br>                .css({<br>                    top: &#39;-&#39; + t.$btnPane.outerHeight() + &#39;px&#39;,<br>                    opacity: 0<br>                })<br>                .appendTo($modal)<br>                .animate({<br>                    top: 0,<br>                    opacity: 1<br>                }, 100);<br><br><br>            // Append title<br>            $(&#39;&lt;span/&gt;&#39;, {<br>                text: title,<br>                class: prefix + &#39;modal-title&#39;<br>            }).prependTo($box);<br><br>            $modal.height($box.outerHeight() + 10);<br><br><br>            // Focus in modal box<br>            $(&#39;input:first&#39;, $box).focus();<br><br><br>            // Append Confirm and Cancel buttons<br>            t.buildModalBtn(&#39;submit&#39;, $box);<br>            t.buildModalBtn(&#39;reset&#39;, $box);<br><br><br>            $(window).trigger(&#39;scroll&#39;);<br><br>            return $modal;<br>        },<br>        // @param n is name of modal<br>        buildModalBtn: function (n, $modal) {<br>            var t = this,<br>                prefix = t.o.prefix;<br><br>            return $(&#39;&lt;button/&gt;&#39;, {<br>                class: prefix + &#39;modal-button &#39; + prefix + &#39;modal-&#39; + n,<br>                type: n,<br>                text: t.lang[n] || n<br>            }).appendTo($(&#39;form&#39;, $modal));<br>        },<br>        // close current modal box<br>        closeModal: function () {<br>            var t = this,<br>                prefix = t.o.prefix;<br><br>            t.$btnPane.removeClass(prefix + &#39;disable&#39;);<br>            t.$overlay.off();<br><br>            // Find the modal box<br>            var $modalBox = $(&#39;.&#39; + prefix + &#39;modal-box&#39;, t.$box);<br><br>            $modalBox.animate({<br>                top: &#39;-&#39; + $modalBox.height()<br>            }, 100, function () {<br>                $modalBox.parent().remove();<br>                t.hideOverlay();<br>            });<br><br>            t.restoreRange();<br>        },<br>        // Preformated build and management modal<br>        openModalInsert: function (title, fields, cmd) {<br>            var t = this,<br>                prefix = t.o.prefix,<br>                lg = t.lang,<br>                html = &#39;&#39;,<br>                CONFIRM_EVENT = &#39;tbwconfirm&#39;;<br><br>            $.each(fields, function (fieldName, field) {<br>                var l = field.label,<br>                    n = field.name || fieldName;<br><br>                html += &#39;&lt;label&gt;&lt;input type=&quot;&#39; + (field.type || &#39;text&#39;) + &#39;&quot; name=&quot;&#39; + n + &#39;&quot; value=&quot;&#39; + (field.value || &#39;&#39;).replace(/&quot;/g, &#39;&amp;quot;&#39;) + &#39;&quot;&gt;&lt;span class=&quot;&#39; + prefix + &#39;input-infos&quot;&gt;&lt;span&gt;&#39; +<br>                    ((!l) ? (lg[fieldName] ? lg[fieldName] : fieldName) : (lg[l] ? lg[l] : l)) +<br>                    &#39;&lt;/span&gt;&lt;/span&gt;&lt;/label&gt;&#39;;<br>            });<br><br>            return t.openModal(title, html)<br>                .on(CONFIRM_EVENT, function () {<br>                    var $form = $(&#39;form&#39;, $(this)),<br>                        valid = true,<br>                        values = {};<br><br>                    $.each(fields, function (fieldName, field) {<br>                        var $field = $(&#39;input[name=&quot;&#39; + fieldName + &#39;&quot;]&#39;, $form);                      <br>                        var inputType = $field.attr(&#39;type&#39;);<br>                        if (inputType.toLowerCase() === &#39;checkbox&#39;) {<br>                            values[fieldName] = $field.is(&#39;:checked&#39;);<br>                        }<br>                        else {<br>                            values[fieldName] = $.trim($field.val());<br>                        }<br>                        // Validate value<br>                        if (field.required &amp;&amp; values[fieldName] === &#39;&#39;) {<br>                            valid = false;<br>                            t.addErrorOnModalField($field, t.lang.required);<br>                        } else if (field.pattern &amp;&amp; !field.pattern.test(values[fieldName])) {<br>                            valid = false;<br>                            t.addErrorOnModalField($field, field.patternError);<br>                        }<br>                    });<br><br>                    if (valid) {<br>                        t.restoreRange();<br><br>                        if (cmd(values, fields)) {<br>                            t.syncCode();<br>                            t.$c.trigger(&#39;tbwchange&#39;);<br>                            t.closeModal();<br>                            $(this).off(CONFIRM_EVENT);<br>                        }<br>                    }<br>                })<br>                .one(&#39;tbwcancel&#39;, function () {<br>                    $(this).off(CONFIRM_EVENT);<br>                    t.closeModal();<br>                });<br>        },<br>        addErrorOnModalField: function ($field, err) {<br>            var prefix = this.o.prefix,<br>                $label = $field.parent();<br><br>            $field<br>                .on(&#39;change keyup&#39;, function () {<br>                    $label.removeClass(prefix + &#39;input-error&#39;);<br>                });<br><br>            $label<br>                .addClass(prefix + &#39;input-error&#39;)<br>                .find(&#39;input+span&#39;)<br>                .append(<br>                    $(&#39;&lt;span/&gt;&#39;, {<br>                        class: prefix + &#39;msg-error&#39;,<br>                        text: err<br>                    })<br>                );<br>        },<br><br><br>        // Range management<br>        saveRange: function () {<br>            var t = this,<br>                documentSelection = t.doc.getSelection();<br><br>            t.range = null;<br><br>            if (documentSelection.rangeCount) {<br>                var savedRange = t.range = documentSelection.getRangeAt(0),<br>                    range = t.doc.createRange(),<br>                    rangeStart;<br>                range.selectNodeContents(t.$ed[0]);<br>                range.setEnd(savedRange.startContainer, savedRange.startOffset);<br>                rangeStart = (range + &#39;&#39;).length;<br>                t.metaRange = {<br>                    start: rangeStart,<br>                    end: rangeStart + (savedRange + &#39;&#39;).length<br>                };<br>            }<br>        },<br>        restoreRange: function () {<br>            var t = this,<br>                metaRange = t.metaRange,<br>                savedRange = t.range,<br>                documentSelection = t.doc.getSelection(),<br>                range;<br><br>            if (!savedRange) {<br>                return;<br>            }<br><br>            if (metaRange &amp;&amp; metaRange.start !== metaRange.end) { // Algorithm from http://jsfiddle.net/WeWy7/3/<br>                var charIndex = 0,<br>                    nodeStack = [t.$ed[0]],<br>                    node,<br>                    foundStart = false,<br>                    stop = false;<br><br>                range = t.doc.createRange();<br><br>                while (!stop &amp;&amp; (node = nodeStack.pop())) {<br>                    if (node.nodeType === 3) {<br>                        var nextCharIndex = charIndex + node.length;<br>                        if (!foundStart &amp;&amp; metaRange.start &gt;= charIndex &amp;&amp; metaRange.start &lt;= nextCharIndex) {<br>                            range.setStart(node, metaRange.start - charIndex);<br>                            foundStart = true;<br>                        }<br>                        if (foundStart &amp;&amp; metaRange.end &gt;= charIndex &amp;&amp; metaRange.end &lt;= nextCharIndex) {<br>                            range.setEnd(node, metaRange.end - charIndex);<br>                            stop = true;<br>                        }<br>                        charIndex = nextCharIndex;<br>                    } else {<br>                        var cn = node.childNodes,<br>                            i = cn.length;<br><br>                        while (i &gt; 0) {<br>                            i -= 1;<br>                            nodeStack.push(cn[i]);<br>                        }<br>                    }<br>                }<br>            }<br><br>            documentSelection.removeAllRanges();<br>            documentSelection.addRange(range || savedRange);<br>        },<br>        getRangeText: function () {<br>            return this.range + &#39;&#39;;<br>        },<br><br>        updateButtonPaneStatus: function () {<br>            var t = this,<br>                prefix = t.o.prefix,<br>                tags = t.getTagsRecursive(t.doc.getSelection().focusNode),<br>                activeClasses = prefix + &#39;active-button &#39; + prefix + &#39;active&#39;;<br><br>            $(&#39;.&#39; + prefix + &#39;active-button&#39;, t.$btnPane).removeClass(activeClasses);<br>            $.each(tags, function (i, tag) {<br>                var btnName = t.tagToButton[tag.toLowerCase()],<br>                    $btn = $(&#39;.&#39; + prefix + btnName + &#39;-button&#39;, t.$btnPane);<br><br>                if ($btn.length &gt; 0) {<br>                    $btn.addClass(activeClasses);<br>                } else {<br>                    try {<br>                        $btn = $(&#39;.&#39; + prefix + &#39;dropdown .&#39; + prefix + btnName + &#39;-dropdown-button&#39;, t.$box);<br>                        var dropdownBtnName = $btn.parent().data(&#39;dropdown&#39;);<br>                        $(&#39;.&#39; + prefix + dropdownBtnName + &#39;-button&#39;, t.$box).addClass(activeClasses);<br>                    } catch (e) {<br>                    }<br>                }<br>            });<br>        },<br>        getTagsRecursive: function (element, tags) {<br>            var t = this;<br>            tags = tags || [];<br><br>            if (element) {<br>                element = element.parentNode;<br>            } else {<br>                return tags;<br>            }<br><br>            var tag = element.tagName;<br>            if (tag === &#39;DIV&#39;) {<br>                return tags;<br>            }<br>            if (tag === &#39;P&#39; &amp;&amp; element.style.textAlign !== &#39;&#39;) {<br>                tags.push(element.style.textAlign);<br>            }<br><br>            $.each(t.tagHandlers, function (i, tagHandler) {<br>                tags = tags.concat(tagHandler(element, t));<br>            });<br><br>            tags.push(tag);<br><br>            return t.getTagsRecursive(element, tags);<br>        },<br><br>        // Plugins<br>        initPlugins: function () {<br>            var t = this;<br>            t.loadedPlugins = [];<br>            $.each($.trumbowyg.plugins, function (name, plugin) {<br>                if (!plugin.shouldInit || plugin.shouldInit(t)) {<br>                    plugin.init(t);<br>                    if (plugin.tagHandler) {<br>                        t.tagHandlers.push(plugin.tagHandler);<br>                    }<br>                    t.loadedPlugins.push(plugin);<br>                }<br>            });<br>        },<br>        destroyPlugins: function () {<br>            $.each(this.loadedPlugins, function (i, plugin) {<br>                if (plugin.destroy) {<br>                    plugin.destroy();<br>                }<br>            });<br>        }<br>    };<br>})(navigator, window, document, jQuery);</body></html>